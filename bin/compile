#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

####### Configure environment

set -e            # fail fast
set -o pipefail   # don't ignore exit codes when piping output
# set -x          # enable debugging

# Configure directories
build_dir="$1/zapnito-web"
cache_dir=$2
env_dir=$3
node_version="0.12.7"
bp_dir=$(cd $(dirname $0); cd ..; pwd)
heroku_dir=$build_dir/.heroku

# Load some convenience functions like status(), echo(), and indent()
source $bp_dir/bin/common.sh

# Avoid GIT_DIR leak from previous build steps
unset GIT_DIR

# Provide hook to deal with errors
trap build_failed ERR

# Load config vars into environment; start with defaults
export EMBER_ENV=production
export_env_dir $env_dir

# Run subsequent commands from the build directory
cd $build_dir

####### Build the project's dependencies

# Download node from Heroku's S3 mirror of nodejs.org/dist
head "Downloading and installing node"
node_url="http://s3pository.heroku.com/node/v${node_version}/node-v${node_version}-linux-x64.tar.gz"
curl $node_url -s -o - | tar xzf - -C $build_dir

# Move node (and npm) into ./vendor and make them executable
mkdir -p $build_dir/vendor
mv $build_dir/node-v$node_version-linux-x64 $build_dir/vendor/node
chmod +x $build_dir/vendor/node/bin/*
PATH=$build_dir/vendor/node/bin:$PATH

head "Building dependencies"

# Install bower
info "Installing bower"
npm install -g bower

# Install bower components
info "Installing bower components"
bower install | indent

# Build ember cli application
build_env=${EMBER_ENV:-production}
head "Building Ember CLI application $build_env distribution"
node_modules/ember-cli/bin/ember build --environment $build_env | indent
